<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Darsh OS</title>
  <style>
    :root {
      --bg-dark: #050505;
      --glass: rgba(255, 255, 255, 0.06);
      --glass-high: rgba(255, 255, 255, 0.15);
      --border: rgba(255, 255, 255, 0.1);
      --accent: #7c3aed; /* Violet */
      --accent-glow: #8b5cf6;
      --text-main: #ffffff;
      --text-muted: #94a3b8;
      --danger: #ef4444;
      --success: #10b981;
      --font-stack: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; user-select: none; }
    
    body {
      margin: 0;
      height: 100vh;
      width: 100vw;
      background: #000;
      font-family: var(--font-stack);
      color: var(--text-main);
      overflow: hidden;
      background: radial-gradient(circle at 50% 120%, #1e1b4b, #000);
      transition: background-image 0.5s ease;
    }

    /* --- LOCK SCREEN --- */
    #lockScreen {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.85);
      backdrop-filter: blur(30px);
      z-index: 9999;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      transition: opacity 0.5s ease, background-image 0.5s ease;
    }
    #lockScreen.hidden { opacity: 0; pointer-events: none; }
    
    .lock-clock { font-size: 60px; font-weight: 200; margin-bottom: 20px; text-shadow: 0 0 20px rgba(255,255,255,0.2); }
    .pin-display { display: flex; gap: 15px; margin-bottom: 30px; }
    .pin-dot { width: 12px; height: 12px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.3); transition: 0.2s; }
    .pin-dot.filled { background: white; border-color: white; box-shadow: 0 0 10px white; }
    
    .numpad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
    .num-btn {
      width: 70px; height: 70px; border-radius: 50%;
      background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.1);
      color: white; font-size: 24px; font-weight: 400; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: background 0.2s;
    }
    .num-btn:active { background: rgba(255,255,255,0.3); }

    /* --- SYSTEM BAR --- */
    #systemBar {
      position: fixed; top: 0; left: 0; width: 100%; height: 44px;
      background: rgba(10, 10, 12, 0.7); backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between; padding: 0 20px;
      z-index: 1000; cursor: pointer; transition: 0.3s;
    }
    #systemBar.active-media {
      background: linear-gradient(90deg, #312e81, #4c1d95, #312e81);
      background-size: 200% 100%; animation: gradientPulse 3s linear infinite;
    }
    @keyframes gradientPulse { 0% { background-position: 100% 0%; } 100% { background-position: -100% 0%; } }

    /* --- 10 NEW SYSTEM BAR ANIMATIONS --- */
    
    /* 1. Shimmer */
    #systemBar.anim-shimmer {
      background: linear-gradient(90deg, rgba(10,10,12,0.9) 0%, rgba(255,255,255,0.2) 50%, rgba(10,10,12,0.9) 100%);
      background-size: 200% 100%; animation: shimmer 2s infinite;
    }
    @keyframes shimmer { 0% { background-position: -100% 0; } 100% { background-position: 100% 0; } }

    /* 2. Pulse Glow */
    #systemBar.anim-pulse {
      animation: pulseGlow 1.5s infinite alternate ease-in-out;
    }
    @keyframes pulseGlow { 0% { box-shadow: 0 0 5px var(--accent); } 100% { box-shadow: 0 0 20px var(--accent), inset 0 0 10px var(--accent); } }

    /* 3. RGB Wave */
    #systemBar.anim-rgb {
      background: linear-gradient(90deg, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #9400d3);
      background-size: 300% 100%;
      animation: rgbWave 3s linear infinite;
    }
    @keyframes rgbWave { 0% { background-position: 0% 50%; } 100% { background-position: 100% 50%; } }

    /* 4. Warning Flash */
    #systemBar.anim-warning {
      background: rgba(239, 68, 68, 0.2);
      animation: warningFlash 1s infinite alternate;
      border-bottom: 1px solid var(--danger);
    }
    @keyframes warningFlash { 0% { background-color: rgba(239,68,68,0.1); box-shadow: 0 0 5px var(--danger); } 100% { background-color: rgba(239,68,68,0.4); box-shadow: 0 0 20px var(--danger); } }

    /* 5. Success Ripple */
    #systemBar.anim-success {
      background: rgba(16, 185, 129, 0.2);
      border-bottom: 1px solid var(--success);
      animation: successPulse 1.5s ease-out infinite;
    }
    @keyframes successPulse { 0% { box-shadow: 0 0 0 0 rgba(16,185,129,0.7); } 100% { box-shadow: 0 0 0 15px rgba(16,185,129,0); } }

    /* 6. AI Thinking (Moving Scanner) */
    #systemBar.anim-ai { position: relative; overflow: hidden; }
    #systemBar.anim-ai::after {
      content: ''; position: absolute; bottom: 0; left: 0; height: 2px; width: 30%;
      background: #fff; box-shadow: 0 -2px 10px #fff;
      animation: aiScan 1.2s ease-in-out infinite alternate;
    }
    @keyframes aiScan { 0% { left: 0%; } 100% { left: 70%; } }

    /* 7. Scanline Overlay */
    #systemBar.anim-scanline {
      background: repeating-linear-gradient(0deg, rgba(255,255,255,0.05) 0px, rgba(255,255,255,0.05) 1px, transparent 1px, transparent 3px), rgba(10,10,12,0.8);
      animation: scanlineMove 5s linear infinite;
    }
    @keyframes scanlineMove { 0% { background-position: 0 0; } 100% { background-position: 0 100px; } }

    /* 8. Neon Border */
    #systemBar.anim-neon {
      border-bottom: 2px solid #0ff;
      animation: neonFlicker 1.5s infinite alternate;
    }
    @keyframes neonFlicker { 
      0%, 19%, 21%, 23%, 25%, 54%, 56%, 100% { box-shadow: 0 2px 15px #0ff, inset 0 -2px 10px #0ff; opacity: 1; } 
      20%, 24%, 55% { box-shadow: none; opacity: 0.8; } 
    }

    /* 9. Matrix Drip */
    #systemBar.anim-matrix {
      background: linear-gradient(180deg, rgba(0,255,0,0) 0%, rgba(0,255,0,0.15) 100%);
      border-bottom: 1px solid #0f0;
      animation: matrixDrip 1.5s linear infinite;
    }
    @keyframes matrixDrip { 0% { background-position: 0 -44px; } 100% { background-position: 0 44px; } }

    /* 10. Data Flow */
    #systemBar.anim-dataflow {
      background: repeating-linear-gradient(45deg, rgba(124,58,237,0.15) 0px, rgba(124,58,237,0.15) 10px, rgba(10,10,12,0.8) 10px, rgba(10,10,12,0.8) 20px);
      background-size: 28px 28px;
      animation: dataFlow 1s linear infinite;
    }
    @keyframes dataFlow { 0% { background-position: 0 0; } 100% { background-position: 28px 28px; } }


    /* --- WIDGETS --- */
    .widgets-area {
      display: flex; gap: 15px; width: 100%; max-width: 500px; padding: 0 10px;
      margin-bottom: 25px; overflow-x: auto; scroll-snap-type: x mandatory;
    }
    .widgets-area::-webkit-scrollbar { display: none; } /* Hide scrollbar for a clean look */
    .widget {
      background: rgba(20, 20, 25, 0.4); border: 1px solid var(--border); border-radius: 18px;
      padding: 16px; flex: 1 1 150px; scroll-snap-align: start; backdrop-filter: blur(25px);
      display: flex; flex-direction: column; justify-content: space-between;
      min-height: 110px; box-shadow: 0 10px 30px rgba(0,0,0,0.4);
      transition: transform 0.2s;
    }
    .widget:hover { transform: translateY(-3px); }
    .widget-title { font-size: 11px; text-transform: uppercase; color: var(--text-muted); font-weight: bold; letter-spacing: 1px; }
    .widget-value { font-size: 24px; font-weight: 300; margin-top: 5px; color: white; }

    /* --- DESKTOP & GRID --- */
    .desktop { padding-top: 70px; display: flex; flex-direction: column; align-items: center; height: 100%; }
    .app-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 24px; max-width: 500px; padding: 10px; width: 100%; }
    .app-item { display: flex; flex-direction: column; align-items: center; gap: 8px; cursor: pointer; transition: transform 0.2s; }
    .app-item:hover { transform: scale(1.08); }
    .app-icon {
      width: 62px; height: 62px; border-radius: 16px; background: var(--glass);
      border: 1px solid var(--border); display: flex; align-items: center; justify-content: center;
      font-size: 28px; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }
    .app-label { font-size: 12px; color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.8); }

    /* --- WINDOWS --- */
    .window {
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9);
      width: min(92%, 850px); height: min(85%, 650px);
      background: rgba(18, 18, 20, 0.92); backdrop-filter: blur(40px);
      border: 1px solid var(--border); border-radius: 18px;
      display: flex; flex-direction: column; opacity: 0; pointer-events: none;
      transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      z-index: 100; box-shadow: 0 40px 100px rgba(0,0,0,0.6);
    }
    .window.open { opacity: 1; pointer-events: all; transform: translate(-50%, -50%) scale(1); }
    
    .win-header {
      height: 52px; padding: 0 16px; display: flex; align-items: center; justify-content: space-between;
      border-bottom: 1px solid var(--border); background: rgba(255,255,255,0.02);
    }
    .win-content { flex: 1; overflow-y: auto; padding: 20px; position: relative; }
    .btn-close {
      width: 30px; height: 30px; border-radius: 50%; border: none; background: rgba(255,255,255,0.08);
      color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s;
    }
    .btn-close:hover { background: var(--danger); transform: rotate(90deg); }

    /* --- COMPONENTS --- */
    .btn {
      padding: 10px 18px; border-radius: 10px; border: 1px solid var(--border); background: var(--glass);
      color: white; cursor: pointer; font-size: 13px; font-weight: 500; transition: 0.2s; display: inline-block;
    }
    .btn:hover { background: var(--glass-high); }
    .btn.primary { background: var(--accent); border-color: var(--accent); }
    .btn.primary:hover { background: var(--accent-glow); box-shadow: 0 0 20px rgba(124, 58, 237, 0.4); }

    input[type="range"] { -webkit-appearance: none; width: 100%; height: 4px; background: rgba(255,255,255,0.2); border-radius: 2px; }
    input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 16px; height: 16px; border-radius: 50%; background: white; cursor: pointer; box-shadow: 0 0 10px rgba(0,0,0,0.5); }

    /* --- AUDIO VISUALIZER & EQ --- */
    .eq-container { display: flex; gap: 10px; justify-content: space-between; margin-top: 15px; }
    .slider-group { display: flex; flex-direction: column; align-items: center; gap: 8px; flex: 1; }
    .slider-v { writing-mode: bt-lr; -webkit-appearance: slider-vertical; width: 8px; height: 100px; }
    .viz-canvas { width: 100%; height: 60px; background: rgba(0,0,0,0.2); border-radius: 8px; margin-bottom: 15px; border: 1px solid var(--border); }
    
    .atmos-toggle {
      display: flex; align-items: center; gap: 10px; background: rgba(255,255,255,0.03); padding: 10px; border-radius: 10px; cursor: pointer; margin-top: 10px;
    }
    .atmos-toggle.active { background: rgba(124, 58, 237, 0.2); border: 1px solid var(--accent); }
    .badge { padding: 2px 6px; border-radius: 4px; background: black; font-size: 10px; font-weight: bold; color: var(--accent-glow); border: 1px solid var(--accent); }

    /* --- GALLERY --- */
    .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; }
    .gallery-item {
      aspect-ratio: 1; background: #000; border-radius: 8px; overflow: hidden; position: relative; border: 1px solid var(--border); cursor: pointer;
    }
    .gallery-item img { width: 100%; height: 100%; object-fit: cover; transition: 0.3s; }
    .gallery-item:hover img { transform: scale(1.1); }
    .gallery-btn-del {
      position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.6); color: var(--danger);
      width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px;
    }

    /* --- DOCK --- */
    .dock {
      position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
      height: 76px; padding: 0 20px; background: rgba(20,20,20,0.5); backdrop-filter: blur(30px);
      border: 1px solid rgba(255,255,255,0.05); border-radius: 24px;
      display: flex; align-items: center; gap: 18px; box-shadow: 0 20px 50px rgba(0,0,0,0.6); z-index: 900;
    }
    .dock .app-icon { width: 50px; height: 50px; font-size: 22px; transition: 0.2s cubic-bezier(0.2, 2, 0.4, 1); }
    .dock .app-icon:hover { transform: translateY(-10px) scale(1.2); }

    /* =========================================
       RESPONSIVE DESIGN (MOBILE & LAPTOP)
       ========================================= */
    
    /* Laptop / Desktop Screens */
    @media (min-width: 1024px) {
      .app-grid { max-width: 800px; grid-template-columns: repeat(5, 1fr); gap: 40px; }
      .app-icon { width: 75px; height: 75px; font-size: 34px; }
      .app-label { font-size: 14px; }
      .window { height: min(80%, 750px); }
      #systemBar { height: 50px; padding: 0 30px; font-size: 15px; }
      .widgets-area { max-width: 800px; gap: 24px; margin-bottom: 40px; }
      .widget { min-height: 120px; }
    }

    /* Mobile Screens */
    @media (max-width: 600px) {
      .app-grid { grid-template-columns: repeat(3, 1fr); gap: 15px; }
      .numpad { gap: 15px; }
      .num-btn { width: 60px; height: 60px; font-size: 20px; }
      .lock-clock { font-size: 50px; }
      .eq-container { flex-wrap: wrap; justify-content: center; }
      .slider-group { flex: 1 1 30%; }
      .dock { width: 90%; padding: 0 10px; justify-content: space-around; }
      .dock .app-icon { width: 45px; height: 45px; font-size: 20px; }
      #systemBar { font-size: 11px; padding: 0 10px; }
      .win-title { font-size: 14px; }
    }

  </style>
</head>
<body>

  <div id="lockScreen" class="hidden">
    <div class="lock-clock" id="lockClock">12:00</div>
    <div style="margin-bottom:20px; font-weight:300;">Enter PIN to Unlock</div>
    <div class="pin-display" id="pinDots">
      <div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div>
    </div>
    <div class="numpad">
      <div class="num-btn" onclick="Lock.press(1)">1</div>
      <div class="num-btn" onclick="Lock.press(2)">2</div>
      <div class="num-btn" onclick="Lock.press(3)">3</div>
      <div class="num-btn" onclick="Lock.press(4)">4</div>
      <div class="num-btn" onclick="Lock.press(5)">5</div>
      <div class="num-btn" onclick="Lock.press(6)">6</div>
      <div class="num-btn" onclick="Lock.press(7)">7</div>
      <div class="num-btn" onclick="Lock.press(8)">8</div>
      <div class="num-btn" onclick="Lock.press(9)">9</div>
      <div class="num-btn" style="border:none; color:var(--danger)" onclick="Lock.clear()">C</div>
      <div class="num-btn" onclick="Lock.press(0)">0</div>
      <div class="num-btn" style="border:none; color:var(--success)" onclick="OS.openApp('phone')">üÜò</div>
    </div>
  </div>

  <div id="systemBar">
    <div style="display:flex; gap:10px; align-items:center;">
      <span style="font-weight:700; letter-spacing:1px;">DARSH OS</span>
      <span id="clock" style="color:var(--text-muted); font-variant-numeric: tabular-nums;">12:00</span>
    </div>
    <div id="barStatus" style="font-size:13px; font-weight:500;">System Secure</div>
    <div style="display:flex; gap:12px; font-size:12px;">
      <span>5G+</span>
      <span>100%</span>
    </div>
  </div>

  <main class="desktop">
    <div id="widgetsArea" class="widgets-area"></div>

    <div class="app-grid" id="desktopGrid"></div>
  </main>

  <div class="dock" id="dock"></div>

  <div class="window" id="win_phone">
    <div class="win-header">
      <div class="win-title">Darsh AI Uplink</div>
      <button class="btn-close" onclick="OS.close('win_phone')">√ó</button>
    </div>
    <div class="win-content" style="display:flex; flex-direction:column;">
      <div style="text-align:center; padding:20px;">
        <div style="width:80px; height:80px; margin:0 auto; border-radius:50%; background:radial-gradient(circle, #8b5cf6, #4c1d95); box-shadow:0 0 40px rgba(139,92,246,0.3); display:flex; align-items:center; justify-content:center; font-size:32px;">‚ö°</div>
        <div id="aiState" style="margin-top:10px; color:var(--text-muted);">Darsh AI Standby</div>
      </div>
      <div id="chatBox" style="flex:1; background:rgba(0,0,0,0.3); border-radius:12px; padding:15px; overflow-y:auto; margin-bottom:15px; border:1px solid var(--border);">
        <div style="background:rgba(255,255,255,0.05); padding:10px; border-radius:8px; margin-bottom:5px;">Hello. I am Darsh AI.</div>
      </div>
      <div style="display:flex; gap:10px;">
        <input id="aiInput" type="text" placeholder="Message Darsh AI..." style="flex:1; background:rgba(255,255,255,0.05); border:none; padding:12px; border-radius:8px; color:white;">
        <button class="btn primary" onclick="AI.send()">Send</button>
        <button class="btn" onclick="AI.listen()">üéôÔ∏è</button>
      </div>
    </div>
  </div>

  <div class="window" id="win_music">
    <div class="win-header">
      <div class="win-title">Sonic Player Pro</div>
      <button class="btn-close" onclick="OS.close('win_music')">√ó</button>
    </div>
    <div class="win-content">
      <canvas id="vizCanvas" class="viz-canvas" height="60"></canvas>
      <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:15px;">
        <div>
          <h3 id="songTitle" style="margin:0;">No Track Loaded</h3>
          <small style="color:var(--text-muted)">Darsh Audio Engine</small>
        </div>
        <div class="atmos-toggle" id="atmosBtn" onclick="AudioEngine.toggleAtmos()">
          <span class="badge">DA</span>
          <span>Spatial Audio</span>
        </div>
      </div>

      <div style="display:flex; gap:10px; margin-bottom:20px;">
        <button class="btn primary" onclick="AudioEngine.playDemo()">Play Demo</button>
        <button class="btn danger" onclick="AudioEngine.stop()">Stop</button>
        <label class="btn" style="cursor:pointer;">
          Load MP3 <input type="file" style="display:none" onchange="AudioEngine.loadLocal(this)">
        </label>
      </div>

      <div style="background:rgba(0,0,0,0.2); padding:15px; border-radius:12px; border:1px solid var(--border);">
        <div style="font-size:11px; text-transform:uppercase; color:var(--text-muted); margin-bottom:10px;">5-Band Graphic EQ</div>
        <div class="eq-container">
          <div class="slider-group"><input type="range" min="-12" max="12" value="0" class="slider-v" oninput="AudioEngine.setGain('low', this.value)"><span>Low</span></div>
          <div class="slider-group"><input type="range" min="-12" max="12" value="0" class="slider-v" oninput="AudioEngine.setGain('lowMid', this.value)"><span>LM</span></div>
          <div class="slider-group"><input type="range" min="-12" max="12" value="0" class="slider-v" oninput="AudioEngine.setGain('mid', this.value)"><span>Mid</span></div>
          <div class="slider-group"><input type="range" min="-12" max="12" value="0" class="slider-v" oninput="AudioEngine.setGain('highMid', this.value)"><span>HM</span></div>
          <div class="slider-group"><input type="range" min="-12" max="12" value="0" class="slider-v" oninput="AudioEngine.setGain('high', this.value)"><span>Hi</span></div>
        </div>
      </div>
      <audio id="mainAudio" crossorigin="anonymous" style="display:none;"></audio>
    </div>
  </div>

  <div class="window" id="win_camera">
    <div class="win-header">
      <div class="win-title">Optic Lens</div>
      <button class="btn-close" onclick="OS.close('win_camera')">√ó</button>
    </div>
    <div class="win-content" style="padding:0; display:flex; flex-direction:column; background:black;">
      <video id="camVideo" autoplay playsinline style="width:100%; height:100%; object-fit:cover;"></video>
      <div style="position:absolute; bottom:20px; width:100%; display:flex; justify-content:center; gap:20px; align-items:center;">
        <button class="btn" style="border-radius:50%; width:50px; height:50px;" onclick="OS.openApp('gallery')">üñºÔ∏è</button>
        <button style="width:70px; height:70px; border-radius:50%; background:white; border:4px solid rgba(255,255,255,0.5); cursor:pointer;" onclick="Camera.snap()"></button>
        <div style="width:50px;"></div>
      </div>
    </div>
  </div>

  <div class="window" id="win_gallery">
    <div class="win-header">
      <div class="win-title">Photos</div>
      <button class="btn-close" onclick="OS.close('win_gallery')">√ó</button>
    </div>
    <div class="win-content">
      <div id="galleryGrid" class="gallery-grid"></div>
      <div id="emptyGallery" style="text-align:center; color:var(--text-muted); margin-top:50px; display:none;">No photos yet.<br>Use Camera to take some.</div>
    </div>
  </div>

  <div class="window" id="win_settings">
    <div class="win-header">
      <div class="win-title">Control Panel</div>
      <button class="btn-close" onclick="OS.close('win_settings')">√ó</button>
    </div>
    <div class="win-content">
      
      <div style="margin-bottom:20px; padding:15px; background:rgba(255,255,255,0.03); border-radius:10px;">
        <h4>Personalization</h4>
        <p style="color:var(--text-muted); font-size:13px; margin-top:0;">Customize your OS backgrounds.</p>
        <div style="display:flex; flex-wrap:wrap; gap:10px;">
          <label class="btn">
            Set Home Wallpaper
            <input type="file" style="display:none" accept="image/*" onchange="SettingsModule.setWallpaper(this, 'home')">
          </label>
          <label class="btn">
            Set Lock Wallpaper
            <input type="file" style="display:none" accept="image/*" onchange="SettingsModule.setWallpaper(this, 'lock')">
          </label>
          <button class="btn danger" onclick="SettingsModule.resetWallpapers()">Reset Default</button>
        </div>
      </div>

      <div style="margin-bottom:20px; padding:15px; background:rgba(255,255,255,0.03); border-radius:10px;">
        <h4>Security</h4>
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
          <span id="pinStateText">No PIN Set</span>
        </div>
        <div style="display:flex; gap:10px;">
          <input type="number" id="settingNewPin" placeholder="New 4-digit PIN" style="background:black; border:1px solid var(--border); color:white; padding:8px; border-radius:6px; width:120px;">
          <button class="btn primary" onclick="Lock.setPin()">Update PIN</button>
        </div>
      </div>

      <div style="padding:15px; background:rgba(255,255,255,0.03); border-radius:10px;">
        <h4>About</h4>
        <p style="color:var(--text-muted); font-size:13px;">Darsh OS v1.0<br>Includes AudioEngine, Gallery, AI, Widgets, Custom Wallpapers, and SecureBoot.</p>
        <button class="btn danger" onclick="localStorage.clear(); location.reload()">Factory Reset</button>
      </div>
    </div>
  </div>

  <script>
    /* =========================================
       OS CORE & APP REGISTRY
       ========================================= */
    const APPS = [
      { id: 'phone', name: 'Phone / AI', icon: 'üìû' },
      { id: 'music', name: 'Music', icon: 'üéµ' },
      { id: 'camera', name: 'Camera', icon: 'üì∏' },
      { id: 'gallery', name: 'Gallery', icon: 'üñºÔ∏è' },
      { id: 'settings', name: 'Settings', icon: '‚öôÔ∏è' },
    ];

    const OS = {
      init: () => {
        // Init Wallpapers
        SettingsModule.initWallpapers();
        
        // Init Widgets
        Widgets.init();

        // Render Icons
        const grid = document.getElementById('desktopGrid');
        const dock = document.getElementById('dock');
        
        APPS.forEach(app => {
          const el = document.createElement('div');
          el.className = 'app-item';
          el.innerHTML = `<div class="app-icon">${app.icon}</div><div class="app-label">${app.name}</div>`;
          el.onclick = () => OS.openApp(app.id);
          grid.appendChild(el);

          // Add to dock (limit to 4)
          if(dock.childElementCount < 4 && app.id !== 'gallery') {
            const d = document.createElement('div');
            d.className = 'app-icon';
            d.innerHTML = app.icon;
            d.onclick = () => OS.openApp(app.id);
            dock.appendChild(d);
          }
        });

        // Clock
        setInterval(() => {
          const t = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
          document.getElementById('clock').innerText = t;
          document.getElementById('lockClock').innerText = t;
        }, 1000);

        // Interactive Animation Cycler for the System Bar
        const barAnimations = [
            'active-media', 'anim-shimmer', 'anim-pulse', 'anim-rgb', 
            'anim-warning', 'anim-success', 'anim-ai', 'anim-scanline', 
            'anim-neon', 'anim-matrix', 'anim-dataflow'
        ];
        let currentAnimIdx = 0;
        document.getElementById('systemBar').onclick = () => {
           currentAnimIdx = (currentAnimIdx + 1) % barAnimations.length;
           const animName = barAnimations[currentAnimIdx];
           OS.setBar("Animation " + animName.replace('anim-', ''), animName);
        };

        // Security Check
        Lock.init();
      },

      openApp: (id) => {
        const win = document.getElementById('win_' + id);
        if(!win) return;
        win.classList.add('open');

        // App Initializers
        if(id === 'camera') Camera.start();
        if(id === 'gallery') Gallery.render();
        if(id === 'music') AudioEngine.initContext();
      },

      close: (id) => {
        document.getElementById(id).classList.remove('open');
        if(id === 'win_camera') Camera.stop();
      },

      setBar: (text, animClass = false) => {
        const b = document.getElementById('systemBar');
        document.getElementById('barStatus').innerText = text;
        
        // Reset classes safely
        b.className = '';
        
        // Apply the relevant new animation class (or fallback to original logic)
        if(animClass === true) {
            b.classList.add('active-media');
        } else if (typeof animClass === 'string') {
            b.classList.add(animClass);
        }
      }
    };

    /* =========================================
       SETTINGS & PERSONALIZATION
       ========================================= */
    const SettingsModule = {
      setWallpaper: (input, type) => {
        const file = input.files[0];
        if(file) {
          const reader = new FileReader();
          reader.onload = (e) => {
            const data = e.target.result;
            if(type === 'home') {
              localStorage.setItem('darsh_wp_home', data);
              document.body.style.backgroundImage = `url(${data})`;
              document.body.style.backgroundSize = 'cover';
              document.body.style.backgroundPosition = 'center';
              OS.setBar("Home Wallpaper Updated", "anim-success");
            } else {
              localStorage.setItem('darsh_wp_lock', data);
              const ls = document.getElementById('lockScreen');
              // Ensure we keep the backdrop blur effect by combining backgrounds or using a pseudo element
              ls.style.backgroundImage = `url(${data})`;
              ls.style.backgroundSize = 'cover';
              ls.style.backgroundPosition = 'center';
              OS.setBar("Lock Wallpaper Updated", "anim-success");
            }
          };
          reader.readAsDataURL(file);
        }
      },
      resetWallpapers: () => {
         localStorage.removeItem('darsh_wp_home');
         localStorage.removeItem('darsh_wp_lock');
         document.body.style.backgroundImage = '';
         document.getElementById('lockScreen').style.backgroundImage = '';
         OS.setBar("Wallpapers Reset", "anim-warning");
      },
      initWallpapers: () => {
         const homeWp = localStorage.getItem('darsh_wp_home');
         if(homeWp) {
            document.body.style.backgroundImage = `url(${homeWp})`;
            document.body.style.backgroundSize = 'cover';
            document.body.style.backgroundPosition = 'center';
         }
         const lockWp = localStorage.getItem('darsh_wp_lock');
         if(lockWp) {
            const ls = document.getElementById('lockScreen');
            ls.style.backgroundImage = `url(${lockWp})`;
            ls.style.backgroundSize = 'cover';
            ls.style.backgroundPosition = 'center';
         }
      }
    };

    /* =========================================
       WIDGETS ENGINE
       ========================================= */
    const Widgets = {
      init: () => {
        const wa = document.getElementById('widgetsArea');
        if(!wa) return;
        
        // Widget 1: Digital Clock & Date
        const w1 = document.createElement('div');
        w1.className = 'widget';
        w1.innerHTML = `<div class="widget-title" id="widgetDate">Date</div>
                        <div class="widget-value" id="widgetClock">--:--</div>`;
                        
        // Widget 2: AI Status
        const w2 = document.createElement('div');
        w2.className = 'widget';
        w2.style.background = 'linear-gradient(135deg, rgba(124, 58, 237, 0.2), rgba(0,0,0,0.4))';
        w2.style.borderColor = 'rgba(124, 58, 237, 0.4)';
        w2.innerHTML = `<div class="widget-title">Darsh AI Core</div>
                        <div class="widget-value" style="color:var(--accent-glow)">Online</div>
                        <div style="font-size:11px; color:var(--text-muted); margin-top:8px;">Ready for uplink sequence</div>`;
                        
        wa.appendChild(w1);
        wa.appendChild(w2);

        // Update Clock Widget live
        setInterval(() => {
          const now = new Date();
          const t = now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit'});
          const d = now.toLocaleDateString([], {weekday:'short', month:'short', day:'numeric'});
          const wc = document.getElementById('widgetClock');
          const wd = document.getElementById('widgetDate');
          if(wc) wc.innerText = t;
          if(wd) wd.innerText = d;
        }, 1000);
      }
    };

    /* =========================================
       LOCK SCREEN & SECURITY
       ========================================= */
    const Lock = {
      buffer: '',
      
      init: () => {
        const pin = localStorage.getItem('darsh_pin');
        if(pin) {
          document.getElementById('lockScreen').classList.remove('hidden');
          document.getElementById('pinStateText').innerText = "System Protected";
        } else {
          document.getElementById('lockScreen').classList.add('hidden');
        }
      },

      press: (num) => {
        if(Lock.buffer.length < 4) {
          Lock.buffer += num;
          Lock.updateDots();
          if(Lock.buffer.length === 4) Lock.check();
        }
      },

      check: () => {
        const stored = localStorage.getItem('darsh_pin');
        if(Lock.buffer === stored) {
          // Unlock
          document.getElementById('lockScreen').style.opacity = '0';
          OS.setBar("System Unlocked", "anim-success"); // trigger a success animation!
          setTimeout(() => {
              document.getElementById('lockScreen').classList.add('hidden');
              OS.setBar("System Secure");
          }, 500);
          Lock.buffer = '';
          Lock.updateDots();
        } else {
          // Shake/Fail
          const pad = document.querySelector('.numpad');
          pad.style.transform = 'translateX(10px)';
          setTimeout(()=>pad.style.transform = 'translateX(-10px)', 50);
          setTimeout(()=>pad.style.transform = 'translateX(0)', 100);
          Lock.buffer = '';
          Lock.updateDots();
        }
      },

      clear: () => {
        Lock.buffer = '';
        Lock.updateDots();
      },

      updateDots: () => {
        const dots = document.querySelectorAll('.pin-dot');
        dots.forEach((d, i) => {
          if(i < Lock.buffer.length) d.classList.add('filled');
          else d.classList.remove('filled');
        });
      },

      setPin: () => {
        const val = document.getElementById('settingNewPin').value;
        if(val.length === 4) {
          localStorage.setItem('darsh_pin', val);
          alert('System Secured. Next boot requires PIN.');
          document.getElementById('pinStateText').innerText = "System Protected";
          document.getElementById('settingNewPin').value = '';
        } else {
          alert('PIN must be 4 digits.');
        }
      }
    };

    /* =========================================
       AUDIO ENGINE (EQ + ATMOS)
       ========================================= */
    const AudioEngine = {
      ctx: null,
      source: null,
      filters: {},
      atmosNode: null,
      analyser: null,
      initialized: false,

      initContext: () => {
        if(AudioEngine.initialized) return;
        const AC = window.AudioContext || window.webkitAudioContext;
        AudioEngine.ctx = new AC();
        const el = document.getElementById('mainAudio');
        AudioEngine.source = AudioEngine.ctx.createMediaElementSource(el);

        // Create EQ Bands
        // Low (Bass), LowMid, Mid, HighMid, High (Treble)
        const freqs = [60, 250, 500, 2000, 8000];
        const types = ['lowshelf', 'peaking', 'peaking', 'peaking', 'highshelf'];
        const keys = ['low', 'lowMid', 'mid', 'highMid', 'high'];
        
        let prevNode = AudioEngine.source;

        keys.forEach((k, i) => {
          const f = AudioEngine.ctx.createBiquadFilter();
          f.frequency.value = freqs[i];
          f.type = types[i];
          f.gain.value = 0;
          prevNode.connect(f);
          prevNode = f;
          AudioEngine.filters[k] = f;
        });

        // Atmos Simulation (Stereo widening)
        // We split channels, delay one, and merge
        const merger = AudioEngine.ctx.createChannelMerger(2);
        const splitter = AudioEngine.ctx.createChannelSplitter(2);
        const delay = AudioEngine.ctx.createDelay();
        delay.delayTime.value = 0.01; // 10ms widening
        
        AudioEngine.atmosInput = AudioEngine.ctx.createGain();
        AudioEngine.atmosDry = AudioEngine.ctx.createGain();
        AudioEngine.atmosWet = AudioEngine.ctx.createGain();
        AudioEngine.atmosWet.gain.value = 0; // Start off

        // Chain: EQ -> AtmosInput -> Split
        prevNode.connect(AudioEngine.atmosInput);
        
        // Dry path (Normal)
        AudioEngine.atmosInput.connect(AudioEngine.atmosDry);
        AudioEngine.atmosDry.connect(AudioEngine.ctx.destination);

        // Wet path (Widening)
        AudioEngine.atmosInput.connect(splitter);
        splitter.connect(delay, 1); // Delay right channel
        splitter.connect(merger, 0, 0); // Left to Left
        delay.connect(merger); // Delayed Right to Right
        merger.connect(AudioEngine.atmosWet);
        AudioEngine.atmosWet.connect(AudioEngine.ctx.destination);

        // Analyser for visualizer
        AudioEngine.analyser = AudioEngine.ctx.createAnalyser();
        AudioEngine.analyser.fftSize = 64;
        AudioEngine.atmosInput.connect(AudioEngine.analyser);
        
        AudioEngine.initialized = true;
        AudioEngine.drawViz();
      },

      setGain: (band, val) => {
        if(AudioEngine.filters[band]) AudioEngine.filters[band].gain.value = parseFloat(val);
      },

      toggleAtmos: () => {
        if(!AudioEngine.initialized) return;
        const btn = document.getElementById('atmosBtn');
        const isActive = btn.classList.contains('active');
        
        if(isActive) {
          btn.classList.remove('active');
          AudioEngine.atmosWet.gain.setTargetAtTime(0, AudioEngine.ctx.currentTime, 0.1);
          AudioEngine.atmosDry.gain.setTargetAtTime(1, AudioEngine.ctx.currentTime, 0.1);
        } else {
          btn.classList.add('active');
          // Boost clarity and width
          AudioEngine.atmosWet.gain.setTargetAtTime(0.8, AudioEngine.ctx.currentTime, 0.1);
          AudioEngine.atmosDry.gain.setTargetAtTime(0.4, AudioEngine.ctx.currentTime, 0.1);
        }
      },

      playDemo: () => {
        AudioEngine.initContext();
        if(AudioEngine.ctx.state === 'suspended') AudioEngine.ctx.resume();
        const el = document.getElementById('mainAudio');
        el.src = 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-8.mp3';
        el.play();
        document.getElementById('songTitle').innerText = "Demo Track";
        OS.setBar("Playing Music", "anim-rgb"); // Trigger new animation
      },

      loadLocal: (input) => {
        AudioEngine.initContext();
        if(AudioEngine.ctx.state === 'suspended') AudioEngine.ctx.resume();
        const file = input.files[0];
        if(file) {
          const el = document.getElementById('mainAudio');
          el.src = URL.createObjectURL(file);
          el.play();
          document.getElementById('songTitle').innerText = file.name;
          OS.setBar("Playing Music", "anim-dataflow"); // Trigger new animation
        }
      },

      stop: () => {
        document.getElementById('mainAudio').pause();
        OS.setBar("System Secure");
      },

      drawViz: () => {
        const canvas = document.getElementById('vizCanvas');
        const ctx = canvas.getContext('2d');
        const w = canvas.width;
        const h = canvas.height;
        const bufferLength = AudioEngine.analyser.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLength);

        const draw = () => {
          requestAnimationFrame(draw);
          AudioEngine.analyser.getByteFrequencyData(dataArray);
          ctx.clearRect(0,0,w,h);
          const barW = (w / bufferLength) * 2.5;
          let x = 0;
          for(let i=0; i<bufferLength; i++) {
            const barH = dataArray[i] / 255 * h;
            ctx.fillStyle = `rgb(${barH + 100}, 92, 246)`;
            ctx.fillRect(x, h-barH, barW, barH);
            x += barW + 1;
          }
        };
        draw();
      }
    };

    /* =========================================
       CAMERA & GALLERY
       ========================================= */
    const Camera = {
      stream: null,
      start: async () => {
        const v = document.getElementById('camVideo');
        try {
          Camera.stream = await navigator.mediaDevices.getUserMedia({ video: true });
          v.srcObject = Camera.stream;
        } catch(e) { alert("Camera access denied."); }
      },
      stop: () => {
        if(Camera.stream) Camera.stream.getTracks().forEach(t=>t.stop());
      },
      snap: () => {
        const v = document.getElementById('camVideo');
        const c = document.createElement('canvas');
        c.width = v.videoWidth; c.height = v.videoHeight;
        c.getContext('2d').drawImage(v,0,0);
        const data = c.toDataURL('image/jpeg');
        Gallery.save(data);
        
        // Flash animation
        const f = document.createElement('div');
        f.style.position='fixed'; f.style.inset=0; f.style.background='white'; f.style.zIndex=999;
        document.body.appendChild(f);
        setTimeout(()=>f.remove(), 100);
      }
    };

    const Gallery = {
      save: (data) => {
        const photos = JSON.parse(localStorage.getItem('darsh_photos') || '[]');
        photos.unshift({id: Date.now(), data: data});
        localStorage.setItem('darsh_photos', JSON.stringify(photos));
      },
      render: () => {
        const g = document.getElementById('galleryGrid');
        const photos = JSON.parse(localStorage.getItem('darsh_photos') || '[]');
        g.innerHTML = '';
        if(photos.length === 0) {
          document.getElementById('emptyGallery').style.display='block';
        } else {
          document.getElementById('emptyGallery').style.display='none';
          photos.forEach(p => {
            const el = document.createElement('div');
            el.className = 'gallery-item';
            el.innerHTML = `<img src="${p.data}" onclick="Gallery.view('${p.data}')">
                            <div class="gallery-btn-del" onclick="Gallery.del(${p.id})">√ó</div>`;
            g.appendChild(el);
          });
        }
      },
      del: (id) => {
        let photos = JSON.parse(localStorage.getItem('darsh_photos') || '[]');
        photos = photos.filter(p => p.id !== id);
        localStorage.setItem('darsh_photos', JSON.stringify(photos));
        Gallery.render();
      },
      view: (src) => {
        const win = window.open("", "_blank");
        win.document.write(`<img src="${src}" style="width:100%">`);
      }
    };

    /* =========================================
       AI LOGIC
       ========================================= */
    const AI = {
      send: () => {
        const inp = document.getElementById('aiInput');
        const txt = inp.value;
        if(!txt) return;
        AI.msg(txt, 'user');
        inp.value = '';
        
        OS.setBar("Processing...", "anim-ai"); // Trigger AI thinking animation

        // Response logic
        setTimeout(() => {
          let r = "I am processing that request.";
          if(txt.match(/hello|hi/i)) r = "Hello, I am Darsh AI. How can I help you?";
          else if(txt.match(/music|song/i)) r = "You can play music in the Music app.";
          else if(txt.match(/time/i)) r = "It is " + new Date().toLocaleTimeString();
          
          AI.msg(r, 'ai');
          AI.speak(r);
        }, 600);
      },
      msg: (txt, type) => {
        const box = document.getElementById('chatBox');
        const d = document.createElement('div');
        d.style.padding = '8px'; d.style.borderRadius = '8px'; d.style.marginBottom = '5px';
        d.style.maxWidth = '80%';
        if(type === 'user') { d.style.background = 'var(--accent)'; d.style.marginLeft = 'auto'; }
        else { d.style.background = 'rgba(255,255,255,0.1)'; }
        d.innerText = txt;
        box.appendChild(d);
        box.scrollTop = box.scrollHeight;
      },
      speak: (txt) => {
        if(window.speechSynthesis) {
          const u = new SpeechSynthesisUtterance(txt);
          window.speechSynthesis.speak(u);
          OS.setBar("Darsh AI Speaking...", "anim-scanline"); // AI scanline animation
          u.onend = () => OS.setBar("System Secure");
        }
      },
      listen: () => {
        if(!window.webkitSpeechRecognition) return alert('Browser not supported');
        const r = new webkitSpeechRecognition();
        r.lang = 'en-US';
        r.onstart = () => { OS.setBar("Listening...", "anim-pulse"); }; // Pulse animation
        r.onresult = (e) => {
          const t = e.results[0][0].transcript;
          document.getElementById('aiInput').value = t;
          AI.send();
        };
        r.onend = () => OS.setBar("System Secure");
        r.start();
      }
    };

    window.onload = OS.init;

  </script>
</body>
</html>